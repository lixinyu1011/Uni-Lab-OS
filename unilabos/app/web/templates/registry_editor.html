{% extends "base.html" %} {% block title %}æ³¨å†Œè¡¨ç¼–è¾‘å™¨ - UniLab{% endblock %}
{% block header %}æ³¨å†Œè¡¨ç¼–è¾‘å™¨{% endblock %} {% block nav %}
{% endblock %} {% block scripts %}
<style>
  .editor-container {
    max-width: 100%;
    margin: 0;
    padding: 10px;
    position: relative;
  }
  .form-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
  }
  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 10px;
    transition: background-color 0.2s;
  }
  .btn-primary {
    background-color: #2196f3;
    color: white;
  }
  .btn-primary:hover {
    background-color: #0b7dda;
  }
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  .btn-secondary:hover {
    background-color: #545b62;
  }
  .radio-group {
    display: flex;
    gap: 15px;
    margin-top: 8px;
  }
  .radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .log-container {
    background: #1e1e1e;
    color: #ffffff;
    border-radius: 4px;
    padding: 15px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    border: 1px solid #444;
  }
  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  .status-disconnected {
    background-color: #f44336;
  }
  .status-connected {
    background-color: #4caf50;
  }
  .status-processing {
    background-color: #ff9800;
  }
  .results-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .results-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid #ddd;
  }
  .result-tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .result-tab.active {
    border-bottom-color: #2196f3;
    color: #2196f3;
    font-weight: bold;
  }
  .result-tab:hover {
    background-color: #f5f5f5;
  }
  .result-content {
    display: none;
  }
  .result-content.active {
    display: block;
  }
  .schema-viewer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    max-height: 500px;
    overflow: auto;
    white-space: pre-wrap;
  }
  .error-message {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
  }
  .success-message {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
  }
  .file-info {
    background: #e9f7fe;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 13px;
    color: #555;
  }
  .file-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .file-browse-btn {
    white-space: nowrap;
    min-width: 100px;
  }
  .form-text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #6c757d;
  }
  .file-analysis-status {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 13px;
  }
  .class-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 13px;
  }
  .file-browser-container {
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
  }
  .current-path {
    padding: 8px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    font-size: 13px;
    color: #555;
  }
  .file-browser {
    max-height: 300px;
    overflow-y: auto;
    padding: 0;
  }
  .file-item {
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
  }
  .file-item:hover {
    background-color: #f8f9fa;
  }
  .file-item.selected {
    background-color: #e3f2fd;
    border-left: 3px solid #2196f3;
  }
  .file-icon {
    margin-right: 8px;
    font-size: 16px;
    width: 20px;
    text-align: center;
  }
  .file-name {
    flex: 1;
    font-size: 14px;
  }
  .file-size {
    font-size: 12px;
    color: #666;
    margin-left: 8px;
  }
  .directory-icon {
    color: #ff9800;
  }
  .python-file-icon {
    color: #4caf50;
  }
  .other-file-icon {
    color: #666;
  }
  .selected-file {
    padding: 8px 12px;
    background: #e8f5e8;
    border-top: 1px solid #ddd;
    font-size: 13px;
  }
  .loading-indicator {
    padding: 20px;
    text-align: center;
    color: #666;
    font-style: italic;
  }
  .yaml-container {
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
  }
  .yaml-header {
    padding: 10px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .copy-yaml-btn {
    font-size: 12px;
    padding: 4px 12px;
  }

  /* è¿æ¥çŠ¶æ€å³ä¸Šè§’å®šä½ */
  .connection-status-fixed {
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    border: 1px solid #ddd;
  }

  /* ä¸»è¦å†…å®¹åŒºåŸŸä¸¤æ å¸ƒå±€ */
  .main-content {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .left-column {
    flex: 1;
    min-width: 0;
  }

  .right-column {
    flex: 1;
    min-width: 0;
  }

  /* æ—¥å¿—åŒºåŸŸåœ¨åº•éƒ¨ */
  .log-section-bottom {
    background: white;
    border-top: 2px solid #e0e0e0;
    padding: 15px;
    margin-top: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1024px) {
    .main-content {
      flex-direction: column;
    }

    .connection-status-fixed {
      position: relative;
      top: auto;
      right: auto;
      margin-bottom: 20px;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="editor-container">
  <!-- è¿æ¥çŠ¶æ€ - å³ä¸Šè§’å›ºå®š -->
  <div class="connection-status-fixed">
    <div id="connection-status">
      <span class="status-indicator status-disconnected" id="status-dot"></span>
      <span id="status-text">æœªè¿æ¥</span>
    </div>
  </div>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <!-- å·¦æ ï¼šæ–‡ä»¶å¯¼å…¥é…ç½® -->
    <div class="left-column">
      <div class="form-section">
        <h3>æ–‡ä»¶å¯¼å…¥é…ç½®</h3>

        <div class="form-group">
          <label for="registry-type">æ³¨å†Œè¡¨ç±»å‹</label>
          <div class="radio-group">
            <div class="radio-option">
              <input
                type="radio"
                id="type-device"
                name="registry-type"
                value="device"
                checked
              />
              <label for="type-device">è®¾å¤‡ (Device)</label>
            </div>
            <div class="radio-option">
              <input
                type="radio"
                id="type-resource"
                name="registry-type"
                value="resource"
              />
              <label for="type-resource">èµ„æº (Resource)</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="file-browser">é€‰æ‹©Pythonæ–‡ä»¶</label>
          <div class="file-browser-container">
            <!-- å½“å‰è·¯å¾„æ˜¾ç¤º -->
            <div class="current-path">
              <strong>å½“å‰è·¯å¾„ï¼š</strong>
              <span id="current-path-display">åŠ è½½ä¸­...</span>
            </div>

            <!-- æ–‡ä»¶æµè§ˆå™¨ -->
            <div class="file-browser" id="file-browser">
              <div class="loading-indicator">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
            </div>

            <!-- é€‰æ‹©çš„æ–‡ä»¶æ˜¾ç¤º -->
            <div class="selected-file" id="selected-file" style="display: none">
              <strong>å·²é€‰æ‹©ï¼š</strong>
              <span id="selected-file-name"></span>
              <span id="selected-file-size" class="file-size"></span>
            </div>
          </div>
          <small class="form-text">åªæ˜¾ç¤º .py æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</small>
        </div>

        <div class="form-group">
          <button
            class="btn btn-secondary"
            onclick="analyzeFile()"
            id="analyze-btn"
            disabled
          >
            åˆ†ææ–‡ä»¶
          </button>
          <small class="form-text">é¦–å…ˆåˆ†ææ–‡ä»¶ä»¥è·å–å¯ç”¨çš„ç±»åˆ—è¡¨</small>
        </div>

        <div
          class="form-group"
          id="class-selection-group"
          style="display: none"
        >
          <label for="class-name" id="class-selection-label">é€‰æ‹©ç±»å</label>
          <select id="class-name" class="form-control">
            <option value="" id="class-selection-option">è¯·é€‰æ‹©ç±»...</option>
          </select>
        </div>

        <div class="form-group">
          <button
            class="btn btn-primary"
            onclick="importFile()"
            id="import-btn"
            disabled
          >
            ç”Ÿæˆæ³¨å†Œè¡¨
          </button>
          <button class="btn btn-secondary" onclick="clearResults()">
            é‡ç½®
          </button>
        </div>

        <div id="workflow-tips" class="class-info">
          <strong>ä½¿ç”¨æµç¨‹:</strong><br />
          1. é€‰æ‹©æ³¨å†Œè¡¨ç±»å‹ï¼ˆè®¾å¤‡/èµ„æºï¼‰<br />
          2. åœ¨æ–‡ä»¶æµè§ˆå™¨ä¸­å¯¼èˆªå¹¶é€‰æ‹©Pythonæ–‡ä»¶<br />
          3. ç‚¹å‡»"åˆ†ææ–‡ä»¶"è·å–å¯ç”¨ç±»åˆ—è¡¨<br />
          4. ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©è¦æ³¨å†Œçš„ç±»<br />
          5. ç‚¹å‡»"ç”Ÿæˆæ³¨å†Œè¡¨"è·å¾—YAMLé…ç½®æ–‡ä»¶
        </div>

        <div id="file-info" class="file-info" style="display: none">
          <strong>æ–‡ä»¶ä¿¡æ¯ï¼š</strong>
          <div id="file-details"></div>
        </div>
      </div>
    </div>

    <!-- å³æ ï¼šæ³¨å†Œè¡¨é…ç½®ç»“æœ -->
    <div class="right-column">
      <div id="results-section" class="form-section" style="display: none">
        <h3>æ³¨å†Œè¡¨é…ç½®ç»“æœ</h3>
        <div class="yaml-container">
          <div class="yaml-header">
            <strong>YAMLæ ¼å¼æ³¨å†Œè¡¨é…ç½®</strong>
            <button
              class="btn btn-secondary copy-yaml-btn"
              onclick="copyYamlToClipboard()"
            >
              å¤åˆ¶YAML
            </button>
          </div>
          <div class="schema-viewer" id="yaml-registry-viewer">ç­‰å¾…æ•°æ®...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¤„ç†æ—¥å¿— - åº•éƒ¨ -->
  <div class="log-section-bottom">
    <h3>å¤„ç†æ—¥å¿—</h3>
    <div id="log-output" class="log-container">ç­‰å¾…æ“ä½œ...</div>
  </div>
</div>

<script>
  let ws = null;
  let isConnected = false;
  let currentPath = '';
  let selectedFilePath = null;

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function () {
    initWebSocket();
    loadFileBrowser(''); // åŠ è½½æ ¹ç›®å½•
    initRegistryTypeListener();
  });

  // åˆå§‹åŒ–æ³¨å†Œè¡¨ç±»å‹ç›‘å¬å™¨
  function initRegistryTypeListener() {
    const radioButtons = document.querySelectorAll(
      'input[name="registry-type"]'
    );
    radioButtons.forEach((radio) => {
      radio.addEventListener('change', function () {
        updateClassSelectionLabel(this.value);
      });
    });

    // åˆå§‹åŒ–æ ‡ç­¾æ–‡å­—
    const checkedRadio = document.querySelector(
      'input[name="registry-type"]:checked'
    );
    if (checkedRadio) {
      updateClassSelectionLabel(checkedRadio.value);
    }
  }

  // æ›´æ–°ç±»é€‰æ‹©æ ‡ç­¾æ–‡å­—
  function updateClassSelectionLabel(registryType) {
    const label = document.getElementById('class-selection-label');
    const option = document.getElementById('class-selection-option');

    if (registryType === 'resource') {
      label.textContent = 'é€‰æ‹©ç±»å/å¯æ‰§è¡Œå‡½æ•°';
      option.textContent = 'è¯·é€‰æ‹©ç±»æˆ–å‡½æ•°...';
    } else {
      label.textContent = 'é€‰æ‹©ç±»å';
      option.textContent = 'è¯·é€‰æ‹©ç±»...';
    }
  }

  // åˆå§‹åŒ–WebSocketè¿æ¥
  function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/registry_editor`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function (event) {
      isConnected = true;
      updateConnectionStatus('connected', 'å·²è¿æ¥');
      addLog('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
    };

    ws.onmessage = function (event) {
      try {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      } catch (e) {
        addLog(`è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`, 'error');
      }
    };

    ws.onclose = function (event) {
      isConnected = false;
      updateConnectionStatus('disconnected', 'è¿æ¥å·²æ–­å¼€');
      addLog('WebSocketè¿æ¥å·²æ–­å¼€', 'warning');

      // 5ç§’åå°è¯•é‡è¿
      setTimeout(initWebSocket, 5000);
    };

    ws.onerror = function (error) {
      addLog('WebSocketè¿æ¥é”™è¯¯', 'error');
      updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
    };
  }

  // æ›´æ–°è¿æ¥çŠ¶æ€
  function updateConnectionStatus(status, text) {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    statusDot.className = `status-indicator status-${status}`;
    statusText.textContent = text;
  }

  // å¤„ç†WebSocketæ¶ˆæ¯
  function handleWebSocketMessage(data) {
    switch (data.type) {
      case 'log':
        addLog(data.message, data.level || 'info');
        break;
      case 'progress':
        updateConnectionStatus('processing', data.message);
        break;
      case 'result':
        handleAnalysisResult(data.data);
        break;
      case 'file_analysis_result':
        handleFileAnalysisResult(data.data);
        break;
      case 'error':
        addLog(data.message, 'error');
        updateConnectionStatus('connected', 'å·²è¿æ¥');
        break;
      default:
        addLog(`æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${data.type}`, 'warning');
    }
  }

  // å¤„ç†åˆ†æç»“æœ
  function handleAnalysisResult(result) {
    updateConnectionStatus('connected', 'å·²è¿æ¥');

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('results-section').style.display = 'block';

    // æ˜¾ç¤ºYAMLæ ¼å¼çš„æ³¨å†Œè¡¨é…ç½®
    if (result.registry_schema) {
      // ç›´æ¥æ˜¾ç¤ºåç«¯è¿”å›çš„YAMLå­—ç¬¦ä¸²
      const yamlViewer = document.getElementById('yaml-registry-viewer');
      yamlViewer.textContent = result.registry_schema;

      // ä¿å­˜YAMLå†…å®¹ä¾›å¤åˆ¶ä½¿ç”¨
      window.registryYaml = result.registry_schema;

      addLog(`ç”Ÿæˆçš„è®¾å¤‡ID: ${result.device_id}`, 'info');
    }

    addLog('æ³¨å†Œè¡¨ç”Ÿæˆå®Œæˆï¼', 'success');
  }

  // å¤åˆ¶YAMLåˆ°å‰ªè´´æ¿
  function copyYamlToClipboard() {
    if (!window.registryYaml) {
      addLog('æ²¡æœ‰å¯å¤åˆ¶çš„YAMLå†…å®¹', 'error');
      return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard
        .writeText(window.registryYaml)
        .then(() => {
          addLog('YAMLé…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');

          // è§†è§‰åé¦ˆ
          const copyBtn = document.querySelector('.copy-yaml-btn');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'å·²å¤åˆ¶!';
          copyBtn.style.backgroundColor = '#4caf50';

          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.backgroundColor = '';
          }, 2000);
        })
        .catch((err) => {
          addLog('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
        });
    } else {
      // åå¤‡æ–¹æ¡ˆï¼šé€‰æ‹©æ–‡æœ¬
      const yamlViewer = document.getElementById('yaml-registry-viewer');
      const range = document.createRange();
      range.selectNodeContents(yamlViewer);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);

      addLog('å·²é€‰æ‹©YAMLæ–‡æœ¬ï¼Œè¯·æŒ‰Ctrl+Cå¤åˆ¶', 'info');
    }
  }

  // æ·»åŠ æ—¥å¿—
  function addLog(message, level = 'info') {
    const logOutput = document.getElementById('log-output');
    const timestamp = new Date().toLocaleTimeString();

    let prefix = '';
    switch (level) {
      case 'error':
        prefix = '[ERROR]';
        break;
      case 'warning':
        prefix = '[WARN]';
        break;
      case 'success':
        prefix = '[SUCCESS]';
        break;
      case 'info':
      default:
        prefix = '[INFO]';
        break;
    }

    const logLine = `${timestamp} ${prefix} ${message}\n`;
    logOutput.textContent += logLine;
    logOutput.scrollTop = logOutput.scrollHeight;
  }

  // åŠ è½½æ–‡ä»¶æµè§ˆå™¨
  async function loadFileBrowser(path) {
    try {
      const response = await fetch(
        `/api/v1/file-browser?path=${encodeURIComponent(path)}`
      );
      const result = await response.json();

      if (result.code === 0) {
        const data = result.data;
        currentPath = data.current_path;
        renderFileBrowser(data);
      } else {
        addLog(`åŠ è½½ç›®å½•å¤±è´¥: ${result.message}`, 'error');
      }
    } catch (error) {
      addLog(`åŠ è½½ç›®å½•æ—¶å‡ºé”™: ${error}`, 'error');
    }
  }

  // æ¸²æŸ“æ–‡ä»¶æµè§ˆå™¨
  function renderFileBrowser(data) {
    const fileBrowser = document.getElementById('file-browser');
    const currentPathDisplay = document.getElementById('current-path-display');

    // æ›´æ–°å½“å‰è·¯å¾„æ˜¾ç¤º
    currentPathDisplay.textContent = data.current_path || data.working_dir;

    // æ¸…ç©ºæ–‡ä»¶æµè§ˆå™¨
    fileBrowser.innerHTML = '';

    // æ·»åŠ è¿”å›ä¸Šçº§ç›®å½•é€‰é¡¹ï¼ˆé™¤äº†æ ¹è·¯å¾„ï¼‰
    const currentPath = data.current_path || data.working_dir;
    if (currentPath && currentPath !== '' && !isRootPath(currentPath)) {
      const parentItem = document.createElement('div');
      parentItem.className = 'file-item';
      parentItem.innerHTML = `
        <span class="file-icon directory-icon">â¬†ï¸</span>
        <span class="file-name">..</span>
        <span class="file-size">(è¿”å›ä¸Šçº§ç›®å½•)</span>
      `;

      // è®¡ç®—ä¸Šçº§ç›®å½•è·¯å¾„
      const parentPath = currentPath.split(/[/\\]/).slice(0, -1).join('/');
      parentItem.onclick = () => loadFileBrowser(parentPath);

      fileBrowser.appendChild(parentItem);
    }

    if (data.items.length === 0) {
      if (fileBrowser.children.length === 0) {
        fileBrowser.innerHTML =
          '<div class="loading-indicator">æ­¤ç›®å½•ä¸ºç©º</div>';
      }
      return;
    }

    // æ¸²æŸ“æ–‡ä»¶å’Œç›®å½•
    data.items.forEach((item) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.dataset.path = item.path;
      fileItem.dataset.type = item.type;

      let icon = '';
      let iconClass = '';

      if (item.type === 'directory') {
        icon = 'ğŸ“';
        iconClass = 'directory-icon';
      } else if (item.is_python) {
        icon = 'ğŸ';
        iconClass = 'python-file-icon';
      } else {
        return; // åªæ˜¾ç¤ºPythonæ–‡ä»¶å’Œç›®å½•
      }

      let sizeText = '';
      if (item.type === 'file') {
        sizeText = `<span class="file-size">(${formatFileSize(
          item.size
        )})</span>`;
      }

      fileItem.innerHTML = `
        <span class="file-icon ${iconClass}">${icon}</span>
        <span class="file-name">${item.name}</span>
        ${sizeText}
      `;

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      if (item.type === 'directory') {
        fileItem.onclick = () => loadFileBrowser(item.path);
      } else if (item.is_python) {
        fileItem.onclick = () => selectFile(item);
      }

      fileBrowser.appendChild(fileItem);
    });
  }

  // é€‰æ‹©æ–‡ä»¶
  function selectFile(fileInfo) {
    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
    document.querySelectorAll('.file-item').forEach((item) => {
      item.classList.remove('selected');
    });

    // æ ‡è®°å½“å‰é€‰æ‹©
    event.target.closest('.file-item').classList.add('selected');

    // ä¿å­˜é€‰æ‹©çš„æ–‡ä»¶ä¿¡æ¯
    selectedFilePath = fileInfo.path;
    window.selectedFileInfo = fileInfo;

    // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶ä¿¡æ¯
    const selectedFileDiv = document.getElementById('selected-file');
    const selectedFileName = document.getElementById('selected-file-name');
    const selectedFileSize = document.getElementById('selected-file-size');

    selectedFileName.textContent = fileInfo.name;
    selectedFileSize.textContent = `(${formatFileSize(fileInfo.size)})`;
    selectedFileDiv.style.display = 'block';

    // å¯ç”¨åˆ†ææŒ‰é’®
    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = false;

    addLog(`å·²é€‰æ‹©æ–‡ä»¶: ${fileInfo.name}`, 'info');
    addLog('ç‚¹å‡»"åˆ†ææ–‡ä»¶"æŒ‰é’®å¼€å§‹åˆ†æ', 'success');
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ ¹è·¯å¾„
  function isRootPath(path) {
    if (!path || path === '') return true;

    // Windowsæ ¹è·¯å¾„ï¼ˆå¦‚ C:, D:, C:\, D:\ï¼‰
    if (/^[A-Za-z]:?\\?$/.test(path)) return true;

    // Unixæ ¹è·¯å¾„
    if (path === '/') return true;

    // ç½‘ç»œè·¯å¾„æ ¹ï¼ˆ\\server æˆ– //serverï¼‰
    if (/^[\\\/]{2}[^\\\/]+$/.test(path)) return true;

    return false;
  }

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  // åˆ†ææ–‡ä»¶
  function analyzeFile() {
    if (!isConnected) {
      addLog('WebSocketæœªè¿æ¥ï¼Œè¯·ç­‰å¾…è¿æ¥å»ºç«‹', 'error');
      return;
    }

    if (!selectedFilePath) {
      addLog('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
      return;
    }

    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'åˆ†æä¸­...';

    const request = {
      type: 'analyze_file',
      data: {
        file_path: selectedFilePath,
      },
    };

    ws.send(JSON.stringify(request));
    addLog(`å¼€å§‹åˆ†ææ–‡ä»¶: ${selectedFilePath}`, 'info');
  }

  // å¤„ç†æ–‡ä»¶åˆ†æç»“æœ
  function handleFileAnalysisResult(analysisResult) {
    const analyzeBtn = document.getElementById('analyze-btn');
    const classSelectionGroup = document.getElementById(
      'class-selection-group'
    );
    const classSelect = document.getElementById('class-name');

    analyzeBtn.disabled = false;
    analyzeBtn.textContent = 'é‡æ–°åˆ†æ';

    if (analysisResult.success) {
      const classes = analysisResult.classes || [];
      const registryType = document.querySelector(
        'input[name="registry-type"]:checked'
      ).value;

      // æ¸…ç©ºç°æœ‰é€‰é¡¹å¹¶è®¾ç½®é»˜è®¤é€‰é¡¹
      const defaultText =
        registryType === 'resource' ? 'è¯·é€‰æ‹©ç±»æˆ–å‡½æ•°...' : 'è¯·é€‰æ‹©ç±»...';
      classSelect.innerHTML = `<option value="">${defaultText}</option>`;

      // æ·»åŠ æ‰¾åˆ°çš„ç±»
      classes.forEach((cls) => {
        const option = document.createElement('option');
        option.value = cls.name;
        option.textContent = `${cls.name} - ${cls.docstring || 'æ— æè¿°'}`;
        classSelect.appendChild(option);
      });

      if (classes.length > 0) {
        classSelectionGroup.style.display = 'block';
        addLog(
          `æ‰¾åˆ° ${classes.length} ä¸ªç±»: ${classes
            .map((c) => c.name)
            .join(', ')}`,
          'success'
        );

        // æ˜¾ç¤ºåˆ†æçŠ¶æ€
        showFileAnalysisStatus(analysisResult);

        // ç›‘å¬ç±»é€‰æ‹©å˜åŒ–ï¼Œå¯ç”¨å¯¼å…¥æŒ‰é’®
        classSelect.onchange = function () {
          const importBtn = document.getElementById('import-btn');
          if (this.value) {
            importBtn.disabled = false;
            addLog(`é€‰æ‹©äº†ç±»: ${this.value}`, 'info');
          } else {
            importBtn.disabled = true;
          }
        };
      } else {
        addLog('æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ç±»å®šä¹‰', 'warning');
        classSelectionGroup.style.display = 'none';
      }
    } else {
      addLog(`æ–‡ä»¶åˆ†æå¤±è´¥: ${analysisResult.error}`, 'error');
      classSelectionGroup.style.display = 'none';
    }
  }

  // æ˜¾ç¤ºæ–‡ä»¶åˆ†æçŠ¶æ€
  function showFileAnalysisStatus(analysisResult) {
    // ç§»é™¤ç°æœ‰çš„åˆ†æçŠ¶æ€æ˜¾ç¤º
    const existingStatus = document.getElementById('file-analysis-status');
    if (existingStatus) {
      existingStatus.remove();
    }

    // åˆ›å»ºæ–°çš„çŠ¶æ€æ˜¾ç¤º
    const statusDiv = document.createElement('div');
    statusDiv.id = 'file-analysis-status';
    statusDiv.className = 'file-analysis-status';

    let statusContent = `
      <strong>æ–‡ä»¶åˆ†æç»“æœ:</strong><br>
      æ–‡ä»¶è·¯å¾„: ${analysisResult.file_path}<br>
      æ¨¡å—å: ${analysisResult.module_name}<br>
      æ‰¾åˆ°ç±»æ•°é‡: ${analysisResult.classes.length}
    `;

    if (analysisResult.classes.length > 0) {
      statusContent += '<br><strong>å¯ç”¨ç±»:</strong>';
      analysisResult.classes.forEach((cls) => {
        statusContent += `<br>â€¢ ${cls.name}: ${cls.docstring || 'æ— æè¿°'}`;
      });
    }

    statusDiv.innerHTML = statusContent;

    // æ’å…¥åˆ°ç±»é€‰æ‹©ç»„å‰é¢
    const classSelectionGroup = document.getElementById(
      'class-selection-group'
    );
    classSelectionGroup.parentNode.insertBefore(statusDiv, classSelectionGroup);
  }

  // å¯¼å…¥æ–‡ä»¶
  function importFile() {
    if (!isConnected) {
      addLog('WebSocketæœªè¿æ¥ï¼Œè¯·ç­‰å¾…è¿æ¥å»ºç«‹', 'error');
      return;
    }

    if (!selectedFilePath) {
      addLog('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
      return;
    }

    const classSelect = document.getElementById('class-name');
    const className = classSelect.value.trim();

    if (!className) {
      addLog('è¯·å…ˆåˆ†ææ–‡ä»¶å¹¶é€‰æ‹©è¦å¯¼å…¥çš„ç±»', 'error');
      return;
    }

    const registryType = document.querySelector(
      'input[name="registry-type"]:checked'
    ).value;

    updateConnectionStatus('processing', 'æ­£åœ¨ç”Ÿæˆæ³¨å†Œè¡¨...');

    const request = {
      type: 'import_file',
      data: {
        file_path: selectedFilePath,
        registry_type: registryType,
        class_name: className,
        module_name: null, // æ¨¡å—åè‡ªåŠ¨ç”Ÿæˆ
      },
    };

    ws.send(JSON.stringify(request));
    addLog(`å¼€å§‹å¯¼å…¥æ–‡ä»¶: ${selectedFilePath}`, 'info');
    addLog(`æ³¨å†Œè¡¨ç±»å‹: ${registryType}`, 'info');
    addLog(`é€‰æ‹©çš„ç±»: ${className}`, 'info');

    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    showFileInfo(selectedFilePath, registryType, className);
  }

  // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
  function showFileInfo(filePath, registryType, className) {
    const fileInfo = document.getElementById('file-info');
    const fileDetails = document.getElementById('file-details');

    let details = `
            <div><strong>æ–‡ä»¶è·¯å¾„:</strong> ${filePath}</div>
            <div><strong>æ³¨å†Œè¡¨ç±»å‹:</strong> ${registryType}</div>
            <div><strong>é€‰æ‹©çš„ç±»:</strong> ${className}</div>
        `;

    fileDetails.innerHTML = details;
    fileInfo.style.display = 'block';
  }

  // æ¸…ç©ºç»“æœ
  function clearResults() {
    // é‡ç½®æ–‡ä»¶é€‰æ‹©
    selectedFilePath = null;
    window.selectedFileInfo = null;

    // æ¸…é™¤æ–‡ä»¶é€‰æ‹©çŠ¶æ€
    document.querySelectorAll('.file-item').forEach((item) => {
      item.classList.remove('selected');
    });

    // éšè—é€‰æ‹©çš„æ–‡ä»¶æ˜¾ç¤º
    document.getElementById('selected-file').style.display = 'none';

    // é‡ç½®åˆ†ææŒ‰é’®
    const analyzeBtn = document.getElementById('analyze-btn');
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = 'åˆ†ææ–‡ä»¶';

    // é‡ç½®å¯¼å…¥æŒ‰é’®
    const importBtn = document.getElementById('import-btn');
    importBtn.disabled = true;

    // éšè—ç±»é€‰æ‹©
    document.getElementById('class-selection-group').style.display = 'none';

    // æ ¹æ®å½“å‰æ³¨å†Œè¡¨ç±»å‹è®¾ç½®é»˜è®¤é€‰é¡¹æ–‡å­—
    const registryType = document.querySelector(
      'input[name="registry-type"]:checked'
    ).value;
    const defaultText =
      registryType === 'resource' ? 'è¯·é€‰æ‹©ç±»æˆ–å‡½æ•°...' : 'è¯·é€‰æ‹©ç±»...';
    document.getElementById(
      'class-name'
    ).innerHTML = `<option value="">${defaultText}</option>`;

    // ç§»é™¤åˆ†æçŠ¶æ€æ˜¾ç¤º
    const analysisStatus = document.getElementById('file-analysis-status');
    if (analysisStatus) {
      analysisStatus.remove();
    }

    // æ¸…ç©ºå…¶ä»–æ˜¾ç¤ºåŒºåŸŸ
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('log-output').textContent = 'ç­‰å¾…æ“ä½œ...';

    // æ¸…ç©ºYAMLæŸ¥çœ‹å™¨
    document.getElementById('yaml-registry-viewer').textContent = 'ç­‰å¾…æ•°æ®...';
    window.registryYaml = null;

    addLog('å·²é‡ç½®æ‰€æœ‰è®¾ç½®', 'info');
  }
</script>
{% endblock %}
